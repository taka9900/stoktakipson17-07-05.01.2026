<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HÄ±rdavat Stok - Mobil Uyumlu</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        /* Performans Ä°yileÅŸtirmeleri */
        * { touch-action: manipulation; } 
        .product-card { content-visibility: auto; contain-intrinsic-size: 100px; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // --- FIREBASE AYARLARI ---
        const firebaseConfig = {
            apiKey: "AIzaSyATqEqYWYEL-EZy4v8E3fw-fYNIDmWpjvc",
            authDomain: "stoktakip-c4c51.firebaseapp.com",
            databaseURL: "https://stoktakip-c4c51-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "stoktakip-c4c51",
            storageBucket: "stoktakip-c4c51.firebasestorage.app",
            messagingSenderId: "341724317170",
            appId: "1:341724317170:web:746ea3fefa38e190dc976b"
        };

        // Firebase BaÅŸlatma (GÃ¼venli Kontrol)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        function StokApp() {
            // --- STATE TANIMLARI ---
            const [currentUser, setCurrentUser] = useState(null);
            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [products, setProducts] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('TÃ¼mÃ¼');
            const [isLoading, setIsLoading] = useState(true);
            const [loadingError, setLoadingError] = useState(null);
            const [settings, setSettings] = useState({ globalDiscount: 0, profitRates: { pesin: 20, vade30: 25, vade60: 30, vade90: 35 } });
            
            // Performans iÃ§in Sayfalama State'i
            const [page, setPage] = useState(1);
            const PRODUCTS_PER_PAGE = 20;

            // --- Ä°LK YÃœKLEME ---
            useEffect(() => {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) setCurrentUser(JSON.parse(savedUser));

                // 30 Saniye Timeout (Mobilde hata vermemesi iÃ§in)
                const timeoutId = setTimeout(() => {
                    if(isLoading) {
                        setLoadingError('Ä°nternet baÄŸlantÄ±nÄ±z yavaÅŸ olabilir, lÃ¼tfen bekleyin...');
                    }
                }, 30000);

                // Verileri Ã‡ek
                const productsRef = database.ref('products');
                const settingsRef = database.ref('settings');

                Promise.all([
                    productsRef.once('value'),
                    settingsRef.once('value')
                ]).then(([prodSnap, setSnap]) => {
                    clearTimeout(timeoutId);
                    
                    if (prodSnap.val()) {
                        const data = prodSnap.val();
                        // Array'e Ã§evir
                        const arr = Object.keys(data).map(key => ({...data[key], id: String(data[key].id || key)}));
                        setProducts(arr);
                    }
                    
                    if (setSnap.val()) {
                        setSettings(prev => ({...prev, ...setSnap.val()}));
                    }
                    
                    setIsLoading(false);
                }).catch(err => {
                    clearTimeout(timeoutId);
                    setLoadingError('Veri yÃ¼klenemedi: ' + err.message);
                    setIsLoading(false);
                });
            }, []);

            // --- HESAPLAMALAR ---
            const filteredProducts = useMemo(() => {
                let result = products;
                if (selectedCategory !== 'TÃ¼mÃ¼') {
                    result = result.filter(p => p.category === selectedCategory);
                }
                if (searchTerm) {
                    const search = searchTerm.toLowerCase();
                    result = result.filter(p => p.name.toLowerCase().includes(search));
                }
                return result;
            }, [products, selectedCategory, searchTerm]);

            // Sayfalama HesabÄ± (Performans iÃ§in kritik)
            const paginatedProducts = useMemo(() => {
                return filteredProducts.slice(0, page * PRODUCTS_PER_PAGE);
            }, [filteredProducts, page]);

            // GiriÅŸ Ä°ÅŸlemi
            const handleLogin = () => {
                // Basit ÅŸifre kontrolÃ¼
                if (loginForm.password === '1234') {
                    const user = { name: loginForm.username, role: loginForm.username === 'admin' ? 'admin' : 'user' };
                    setCurrentUser(user);
                    localStorage.setItem('currentUser', JSON.stringify(user));
                } else {
                    alert('Åžifre hatalÄ±! (1234)');
                }
            };

            // Fiyat Hesapla
            const calcPrice = (price) => {
                const disc = settings.globalDiscount || 0;
                return disc > 0 ? price * (1 - disc / 100) : price;
            };

            // --- ARAYÃœZLER (RENDER) ---

            // 1. YÃ¼kleniyor EkranÄ±
            if (isLoading) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <div className="animate-spin text-4xl mb-4">ðŸ“¦</div>
                        <p>YÃ¼kleniyor...</p>
                        {loadingError && <p className="text-red-500 text-sm mt-2">{loadingError}</p>}
                    </div>
                );
            }

            // 2. GiriÅŸ EkranÄ±
            if (!currentUser) {
                return (
                    <div className="min-h-screen bg-blue-600 flex items-center justify-center p-4">
                        <div className="bg-white p-6 rounded-lg w-full max-w-sm shadow-xl">
                            <h1 className="text-2xl font-bold text-center mb-6">HÄ±rdavat Stok</h1>
                            <input 
                                type="text" 
                                placeholder="KullanÄ±cÄ± AdÄ±"
                                className="w-full border p-3 rounded mb-3"
                                onChange={e => setLoginForm({...loginForm, username: e.target.value})}
                            />
                            <input 
                                type="password" 
                                placeholder="Åžifre (1234)"
                                className="w-full border p-3 rounded mb-4"
                                onChange={e => setLoginForm({...loginForm, password: e.target.value})}
                            />
                            <button onClick={handleLogin} className="w-full bg-blue-600 text-white p-3 rounded font-bold">
                                GÄ°RÄ°Åž YAP
                            </button>
                        </div>
                    </div>
                );
            }

            // 3. Ana Ekran
            return (
                <div className="pb-10">
                    {/* Ãœst Bar */}
                    <div className="bg-blue-600 text-white p-4 sticky top-0 z-10 shadow-md">
                        <div className="flex justify-between items-center">
                            <h1 className="font-bold text-lg">ðŸ“¦ Stok Takip</h1>
                            <button onClick={() => {setCurrentUser(null); localStorage.removeItem('currentUser');}} className="bg-red-500 px-3 py-1 rounded text-sm">Ã‡Ä±kÄ±ÅŸ</button>
                        </div>
                    </div>

                    {/* Arama ve Filtre */}
                    <div className="p-4 bg-white shadow-sm">
                        <input 
                            type="text" 
                            placeholder="ðŸ” ÃœrÃ¼n Ara..." 
                            className="w-full border p-3 rounded-lg mb-3"
                            value={searchTerm}
                            onChange={(e) => {setSearchTerm(e.target.value); setPage(1);}}
                        />
                        <div className="flex gap-2 overflow-x-auto pb-2">
                            {['TÃ¼mÃ¼', ...new Set(products.map(p => p.category))].map(cat => (
                                <button 
                                    key={cat}
                                    onClick={() => {setSelectedCategory(cat); setPage(1);}}
                                    className={`px-4 py-2 rounded-full whitespace-nowrap text-sm ${selectedCategory === cat ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}
                                >
                                    {cat}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* ÃœrÃ¼n Listesi */}
                    <div className="p-4 space-y-3">
                        {paginatedProducts.map((p) => {
                            const netPrice = calcPrice(p.priceTL || 0);
                            return (
                                <div key={p.id} className="bg-white p-4 rounded-lg shadow product-card border-l-4 border-blue-500">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h3 className="font-bold text-lg">{p.name}</h3>
                                            <p className="text-sm text-gray-500">{p.category}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-xl font-bold text-blue-600">â‚º{netPrice.toFixed(2)}</p>
                                            <p className="text-sm font-semibold text-gray-600">Stok: {p.currentStock}</p>
                                        </div>
                                    </div>
                                    
                                    {/* HÄ±zlÄ± Fiyatlar */}
                                    <div className="mt-3 grid grid-cols-2 gap-2 text-xs">
                                        <div className="bg-green-50 p-2 rounded">
                                            <span className="block text-gray-500">PeÅŸin</span>
                                            <span className="font-bold text-green-700">â‚º{(netPrice * 1.20).toFixed(2)}</span>
                                        </div>
                                        <div className="bg-orange-50 p-2 rounded">
                                            <span className="block text-gray-500">Vadeli (30G)</span>
                                            <span className="font-bold text-orange-700">â‚º{(netPrice * 1.25).toFixed(2)}</span>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}

                        {/* Daha Fazla YÃ¼kle Butonu */}
                        {paginatedProducts.length < filteredProducts.length && (
                            <button 
                                onClick={() => setPage(prev => prev + 1)}
                                className="w-full py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold mt-4"
                            >
                                Daha Fazla GÃ¶ster ({filteredProducts.length - paginatedProducts.length} Ã¼rÃ¼n kaldÄ±)
                            </button>
                        )}

                        {filteredProducts.length === 0 && (
                            <div className="text-center py-10 text-gray-500">ÃœrÃ¼n bulunamadÄ±</div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StokApp />);
    </script>
</body>
</html>
